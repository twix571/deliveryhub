<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delivery Goals</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/svg+xml" sizes="192x192" href="icon-192.svg">
    <link rel="apple-touch-icon" sizes="192x192" href="icon-192.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* Hide scrollbar but allow scrolling */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="bg-black min-h-screen">
    <div id="main-container" class="relative w-full h-screen overflow-hidden">
        <!-- Tab Selector (Hidden by default) -->
        <div id="tab-selector" class="hidden absolute inset-0 bg-black/80 flex items-center justify-center z-50">
            <div class="flex flex-col gap-4 items-center">
                <button onclick="switchTab('deliveries')" class="w-64 h-16 bg-black border border-white text-white text-xl font-semibold rounded-lg transition-colors">
                    Deliveries
                </button>
                <button onclick="switchTab('analysis')" class="w-64 h-16 bg-black border border-white text-white text-xl font-semibold rounded-lg transition-colors">
                    Analysis
                </button>
                <button onclick="switchTab('settings')" class="w-64 h-16 bg-black border border-white text-white text-xl font-semibold rounded-lg transition-colors">
                    Settings
                </button>
            </div>
        </div>

        <!-- Content Sections -->
        <div id="content-area" class="w-full h-full flex items-center justify-center">
            <!-- Deliveries Section -->
            <div id="deliveries-section" class="hidden w-full h-full p-4 md:p-8 overflow-y-auto hide-scrollbar">
                <h1 class="text-3xl md:text-4xl font-bold text-white mb-6">Deliveries</h1>
                <div class="bg-black border border-white rounded-lg p-6 max-w-4xl mx-auto">
                    <div class="space-y-6">
                        <!-- Add Delivery Form -->
                        <div class="bg-black/50 border border-white rounded-lg p-6">
                            <h2 class="text-xl font-bold text-white mb-4">Add New Delivery</h2>
                            <div class="space-y-4">
                                <div>
                                    <label for="delivery-amount" class="block text-white text-lg font-medium mb-2">Earnings ($)</label>
                                    <input type="number" id="delivery-amount" step="0.01" min="0" placeholder="Enter delivery earnings"
                                        class="w-full px-4 py-3 bg-black border border-white text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-white focus:border-transparent">
                                </div>
                                <div>
                                    <label for="delivery-date" class="block text-white text-lg font-medium mb-2">Date & Time</label>
                                    <input type="datetime-local" id="delivery-date"
                                        class="w-full px-4 py-3 bg-black border border-white text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-white focus:border-transparent">
                                </div>
                                <button onclick="addDelivery()" class="w-full bg-black border border-white text-white text-lg font-semibold py-3 px-6 rounded-lg transition-colors">
                                    Add Delivery
                                </button>
                            </div>
                        </div>

                        <!-- Delivery List -->
                        <div class="bg-black/50 border border-white rounded-lg p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-bold text-white">Delivery History</h2>
                                <button onclick="clearAllDeliveries()" class="text-white text-sm hover:text-gray-300 underline">
                                    Clear All
                                </button>
                            </div>
                            <div id="delivery-list" class="space-y-3 max-h-96 overflow-y-auto hide-scrollbar">
                                <p class="text-white text-center text-gray-400">No deliveries yet. Add your first delivery above!</p>
                            </div>
                        </div>

                        <!-- Summary Stats -->
                        <div class="bg-black/50 border border-white rounded-lg p-6">
                            <h2 class="text-xl font-bold text-white mb-4">Summary</h2>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="text-center">
                                    <p class="text-white text-sm">Total Earnings</p>
                                    <p class="text-white text-2xl font-bold" id="total-earnings">$0.00</p>
                                </div>
                                <div class="text-center">
                                    <p class="text-white text-sm">Total Deliveries</p>
                                    <p class="text-white text-2xl font-bold" id="total-deliveries">0</p>
                                </div>
                                <div class="text-center">
                                    <p class="text-white text-sm">Average per Delivery</p>
                                    <p class="text-white text-2xl font-bold" id="avg-delivery">$0.00</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analysis Section -->
            <div id="analysis-section" class="hidden w-full h-full p-4 md:p-8 overflow-y-auto hide-scrollbar">
                <h1 class="text-3xl md:text-4xl font-bold text-white mb-6">Analysis</h1>
                <div class="bg-black border border-white rounded-lg p-6 max-w-4xl mx-auto">
                    <div class="space-y-8">
                        <!-- Monthly Goal Status -->
                        <div class="bg-black/50 border border-white rounded-lg p-6">
                            <h2 class="text-2xl font-bold text-white mb-4">Monthly Goal Progress</h2>
                            <div id="goal-progress-container">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-white text-lg">Goal: <span id="display-monthly-goal" class="font-bold">$0.00</span></span>
                                    <span class="text-white text-lg">Orders Needed: <span id="orders-needed" class="font-bold">0</span></span>
                                </div>
                                <div class="w-full bg-gray-700 rounded-full h-4 mb-4">
                                    <div id="progress-bar" class="bg-white h-4 rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                                <p id="progress-message" class="text-white text-center text-lg">Enter your monthly goal in settings to see progress</p>
                            </div>
                        </div>

                        <!-- Daily Targets -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-black/50 border border-white rounded-lg p-6">
                                <h3 class="text-xl font-bold text-white mb-2">Daily Target</h3>
                                <p class="text-white text-3xl font-bold" id="daily-target">$0.00</p>
                                <p class="text-white text-sm mt-1" id="daily-orders">0 orders per day</p>
                            </div>
                            <div class="bg-black/50 border border-white rounded-lg p-6">
                                <h3 class="text-xl font-bold text-white mb-2">Weekly Target</h3>
                                <p class="text-white text-3xl font-bold" id="weekly-target">$0.00</p>
                                <p class="text-white text-sm mt-1" id="weekly-orders">0 orders per week</p>
                            </div>
                        </div>

                        <!-- Average Per Order -->
                        <div class="bg-black/50 border border-white rounded-lg p-6">
                            <h3 class="text-xl font-bold text-white mb-2">Average Per Delivery Order</h3>
                            <p class="text-white text-3xl font-bold" id="display-avg-per-order">$0.00</p>
                        </div>

                        <!-- Calculation Summary -->
                        <div class="bg-black/50 border border-white rounded-lg p-6">
                            <h3 class="text-xl font-bold text-white mb-4">Calculation Summary</h3>
                            <div class="space-y-2 text-white" id="calculation-summary">
                                <p>Enter your monthly goal and average per order in settings to see calculated targets.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Section -->
            <div id="settings-section" class="hidden w-full h-full p-4 md:p-8 overflow-y-auto hide-scrollbar">
                <h1 class="text-3xl md:text-4xl font-bold text-white mb-6">Settings</h1>
                <div class="bg-black border border-white rounded-lg p-6 max-w-2xl">
                    <div class="space-y-6">
                        <div>
                            <label for="monthly-goal" class="block text-white text-lg font-medium mb-2">Monthly Goal ($)</label>
                            <input type="number" id="monthly-goal" step="0.01" min="0" placeholder="Enter your monthly goal"
                                class="w-full px-4 py-3 bg-black border border-white text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-white focus:border-transparent">
                            <p class="text-white text-sm mt-1">Target earnings for the month</p>
                        </div>
                        <div>
                            <label for="avg-per-order" class="block text-white text-lg font-medium mb-2">Average $ per Delivery Order</label>
                            <input type="number" id="avg-per-order" step="0.01" min="0" placeholder="Enter average per order"
                                class="w-full px-4 py-3 bg-black border border-white text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-white focus:border-transparent">
                            <p class="text-white text-sm mt-1">Average earnings per delivery order</p>
                        </div>
                        <button onclick="saveSettings()" class="w-full bg-black border border-white text-white text-lg font-semibold py-3 px-6 rounded-lg transition-colors">
                            Save Settings
                        </button>
                        <p id="save-message" class="text-white text-center hidden">Settings saved successfully!</p>
                    </div>
                </div>
            </div>

            <!-- Default Welcome Screen -->
            <div id="welcome-screen" class="text-center">
                <h1 class="text-3xl md:text-5xl font-bold text-white mb-4">Delivery Goals</h1>
                <p class="text-white text-lg md:text-xl mb-8">Double-click anywhere or tap the button to open tabs</p>
                <button id="menu-button" class="bg-black border border-white text-white text-lg font-semibold py-3 px-8 rounded-lg transition-colors shadow-lg">
                    Open Menu
                </button>
            </div>
        </div>
    </div>

    <script>
        // Register service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').then(() => {
                console.log('Service Worker registered');
            }).catch(err => {
                console.log('Service Worker registration failed', err);
            });
        }

        const tabSelector = document.getElementById('tab-selector');
        const contentArea = document.getElementById('content-area');
        const welcomeScreen = document.getElementById('welcome-screen');
        const mainContainer = document.getElementById('main-container');
        const menuButton = document.getElementById('menu-button');

        // Debounce function to prevent excessive saves
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Comprehensive app data structure
        let appData = {
            settings: {
                monthlyGoal: '',
                avgPerOrder: ''
            },
            deliveries: [],
            analysis: {
                totalEarnings: 0,
                totalDeliveries: 0,
                averagePerDelivery: 0
            },
            ui: {
                currentTab: '',
                lastVisited: Date.now()
            }
        };

        // Flag to prevent auto-save during initial load
        let isInitialLoad = true;

        // Debug utility - set to false to disable all logging
        const ENABLE_DEBUG = true;

        // Simple debug logging function
        function debug(category, action, data = null) {
            if (ENABLE_DEBUG) {
                const timestamp = new Date().toLocaleTimeString();
                if (data !== null) {
                    console.log(`[${timestamp}] [${category}] ${action}`, data);
                } else {
                    console.log(`[${timestamp}] [${category}] ${action}`);
                }
            }
        }

        // Function wrapper for automatic debug logging
        function debugWrap(fnName, fn) {
            if (!ENABLE_DEBUG) return fn;
            return function(...args) {
                const timestamp = new Date().toLocaleTimeString();
                console.log(`[${timestamp}] [${fnName}] CALLED with`, args);
                const result = fn.apply(this, args);
                console.log(`[${timestamp}] [${fnName}] RETURNED`, result);
                return result;
            };
        }

        // Save all app data to localStorage
        function saveAllData() {
            debug('DATA', 'Saving all data...', { currentTab: appData.ui.currentTab });

            const dataToSave = {
                ...appData,
                settings: {
                    monthlyGoal: document.getElementById('monthly-goal')?.value || '',
                    avgPerOrder: document.getElementById('avg-per-order')?.value || ''
                },
                ui: {
                    ...appData.ui,
                    currentTab: getCurrentActiveTab(),
                    lastVisited: Date.now()
                }
            };
            localStorage.setItem('orderCalcData', JSON.stringify(dataToSave));
            debug('DATA', 'All data saved successfully', { deliveriesCount: appData.deliveries?.length });
        }

        // Save scroll position
        function saveScrollPositions() {
            const sections = ['deliveries-section', 'analysis-section', 'settings-section'];
            sections.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) {
                    localStorage.setItem(`scroll_${sectionId}`, section.scrollTop);
                }
            });
        }

        // Restore scroll position for a specific section
        function restoreScrollPosition(sectionId) {
            const savedScroll = localStorage.getItem(`scroll_${sectionId}`);
            if (savedScroll !== null) {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.scrollTop = parseInt(savedScroll, 10);
                }
            }
        }

        // Get currently active tab
        function getCurrentActiveTab() {
            const sections = ['deliveries-section', 'analysis-section', 'settings-section'];
            for (const sectionId of sections) {
                const section = document.getElementById(sectionId);
                if (section && !section.classList.contains('hidden')) {
                    return sectionId.replace('-section', '');
                }
            }
            return '';
        }

        // Load all app data from localStorage
        function loadAllData() {
            debug('DATA', 'Loading all data...');

            const savedData = localStorage.getItem('orderCalcData');
            if (savedData) {
                try {
                    const parsedData = JSON.parse(savedData);
                    appData = parsedData;

                    // Restore settings
                    if (parsedData.settings?.monthlyGoal !== undefined) {
                        document.getElementById('monthly-goal').value = parsedData.settings.monthlyGoal;
                    }
                    if (parsedData.settings?.avgPerOrder !== undefined) {
                        document.getElementById('avg-per-order').value = parsedData.settings.avgPerOrder;
                    }

                    // Restore delivery data
                    if (!appData.deliveries) {
                        appData.deliveries = [];
                    }
                    updateDeliveryList();
                    updateDeliveryStats();

                    // Restore previous tab if available, otherwise default to analysis
                    const tabToRestore = parsedData.ui?.currentTab || 'analysis';
                    debug('UI', 'Restoring tab', { tab: tabToRestore });
                    setTimeout(() => {
                        restoreUIState(tabToRestore);
                    }, 100);

                    debug('DATA', 'All data loaded successfully', { tab: tabToRestore, deliveries: appData.deliveries?.length });
                } catch (e) {
                    debug('ERROR', 'Error loading data', e);
                    console.error('Error loading data:', e);
                }
            } else {
                debug('DATA', 'No saved data found, initializing...');
                // First time - default to analysis tab
                setTimeout(() => {
                    restoreUIState('analysis');
                }, 100);
            }
        }

        // Restore UI state (tab and scroll position)
        function restoreUIState(tab) {
            if (tab && document.getElementById(`${tab}-section`)) {
                switchTab(tab);
                // Restore scroll position after tab is visible
                setTimeout(() => {
                    restoreScrollPosition(`${tab}-section`);
                }, 150);
            }
        }

        // Load settings from localStorage (legacy function, kept for compatibility)
        function loadSettings() {
            loadAllData();
        }

        // Save settings to localStorage (legacy function, kept for compatibility)
        function saveSettings() {
            debug('SETTINGS', 'Save Settings clicked');

            // Close tab selector if open to prevent interference
            tabSelector.classList.add('hidden');

            saveAllData();

            const saveMessage = document.getElementById('save-message');
            saveMessage.classList.remove('hidden');
            setTimeout(() => {
                saveMessage.classList.add('hidden');
            }, 2000);

            // Update analysis and navigate to analysis page after saving
            updateAnalysis();

            debug('UI', 'Navigating to Analysis page after save...');

            // Direct navigation to analysis using base switchTab logic
            setTimeout(() => {
                document.querySelectorAll('[id$="-section"]').forEach(section => {
                    section.classList.add('hidden');
                });
                welcomeScreen.classList.add('hidden');
                document.getElementById('analysis-section').classList.remove('hidden');
                appData.ui.currentTab = 'analysis';
                isInitialLoad = false;
                debug('UI', 'Navigation to Analysis complete');
            }, 600);
        }

        // Calculate and update analysis page
        function updateAnalysis() {
            const monthlyGoal = parseFloat(document.getElementById('monthly-goal')?.value) || 0;
            const avgPerOrder = parseFloat(document.getElementById('avg-per-order')?.value) || 0;

            // Update display values
            document.getElementById('display-monthly-goal').textContent = `$${monthlyGoal.toFixed(2)}`;
            document.getElementById('display-avg-per-order').textContent = `$${avgPerOrder.toFixed(2)}`;

            if (monthlyGoal > 0 && avgPerOrder > 0) {
                // Calculate orders needed
                const ordersNeeded = Math.ceil(monthlyGoal / avgPerOrder);
                document.getElementById('orders-needed').textContent = ordersNeeded;

                // Calculate daily target (assuming 30 days per month)
                const dailyTarget = monthlyGoal / 30;
                document.getElementById('daily-target').textContent = `$${dailyTarget.toFixed(2)}`;
                const dailyOrders = Math.ceil(dailyTarget / avgPerOrder);
                document.getElementById('daily-orders').textContent = `${dailyOrders} orders per day`;

                // Calculate weekly target (4 weeks per month)
                const weeklyTarget = monthlyGoal / 4;
                document.getElementById('weekly-target').textContent = `$${weeklyTarget.toFixed(2)}`;
                const weeklyOrders = Math.ceil(weeklyTarget / avgPerOrder);
                document.getElementById('weekly-orders').textContent = `${weeklyOrders} orders per week`;

                // Update progress message
                document.getElementById('progress-message').textContent = `You need ${ordersNeeded} orders at $${avgPerOrder.toFixed(2)} per order to reach your $${monthlyGoal.toFixed(2)} goal.`;

                // Update calculation summary
                document.getElementById('calculation-summary').innerHTML = `
                    <p>• Monthly Goal: $${monthlyGoal.toFixed(2)}</p>
                    <p>• Average per Order: $${avgPerOrder.toFixed(2)}</p>
                    <p>• Total Orders Needed: ${ordersNeeded}</p>
                    <p>• Daily Target: $${dailyTarget.toFixed(2)} (${dailyOrders} orders)</p>
                    <p>• Weekly Target: $${weeklyTarget.toFixed(2)} (${weeklyOrders} orders)</p>
                `;

                // Calculate progress (if we have delivery data in the future)
                const currentEarnings = appData.analysis?.totalEarnings || 0;
                const progressPercent = Math.min((currentEarnings / monthlyGoal) * 100, 100);
                document.getElementById('progress-bar').style.width = `${progressPercent}%`;
            } else {
                // Reset displays if no values
                document.getElementById('orders-needed').textContent = '0';
                document.getElementById('daily-target').textContent = '$0.00';
                document.getElementById('daily-orders').textContent = '0 orders per day';
                document.getElementById('weekly-target').textContent = '$0.00';
                document.getElementById('weekly-orders').textContent = '0 orders per week';
                document.getElementById('progress-bar').style.width = '0%';
                document.getElementById('progress-message').textContent = 'Enter your monthly goal and average per order in settings to see calculated targets.';
                document.getElementById('calculation-summary').innerHTML = '<p>Enter your monthly goal and average per order in settings to see calculated targets.</p>';
            }
        }

        // Add a new delivery
        function addDelivery() {
            const amount = parseFloat(document.getElementById('delivery-amount').value);
            const dateInput = document.getElementById('delivery-date').value;

            debug('DELIVERY', 'Add delivery attempted', { amount, dateInput });

            if (isNaN(amount) || amount <= 0) {
                debug('DELIVERY', 'Invalid amount provided', { amount });
                alert('Please enter a valid amount');
                return;
            }

            const delivery = {
                id: Date.now(),
                amount: amount,
                date: dateInput || new Date().toISOString().slice(0, 16),
                timestamp: Date.now()
            };

            appData.deliveries.push(delivery);
            appData.deliveries.sort((a, b) => b.timestamp - a.timestamp); // Sort by most recent

            debug('DELIVERY', 'Delivery added successfully', { id: delivery.id, amount, totalDeliveries: appData.deliveries.length });

            saveAllData();
            updateDeliveryList();
            updateDeliveryStats();
            updateAnalysis(); // Update analysis with new delivery data

            // Clear form
            document.getElementById('delivery-amount').value = '';
            document.getElementById('delivery-date').value = '';
        }

        // Clear all deliveries
        function clearAllDeliveries() {
            if (confirm('Are you sure you want to clear all deliveries? This cannot be undone.')) {
                appData.deliveries = [];
                saveAllData();
                updateDeliveryList();
                updateDeliveryStats();
                updateAnalysis();
            }
        }

        // Update delivery list display
        function updateDeliveryList() {
            const deliveryList = document.getElementById('delivery-list');
            const deliveries = appData.deliveries || [];

            if (deliveries.length === 0) {
                deliveryList.innerHTML = '<p class="text-white text-center text-gray-400">No deliveries yet. Add your first delivery above!</p>';
                return;
            }

            deliveryList.innerHTML = deliveries.map(delivery => {
                const date = new Date(delivery.date);
                const formattedDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                return `
                    <div class="bg-black border border-white rounded-lg p-4 flex justify-between items-center">
                        <div>
                            <p class="text-white font-semibold">$${delivery.amount.toFixed(2)}</p>
                            <p class="text-white text-sm text-gray-400">${formattedDate}</p>
                        </div>
                        <button onclick="deleteDelivery(${delivery.id})" class="text-red-400 hover:text-red-300 text-sm">Delete</button>
                    </div>
                `;
            }).join('');
        }

        // Delete a delivery
        function deleteDelivery(id) {
            appData.deliveries = appData.deliveries.filter(d => d.id !== id);
            saveAllData();
            updateDeliveryList();
            updateDeliveryStats();
            updateAnalysis();
        }

        // Update delivery statistics
        function updateDeliveryStats() {
            const deliveries = appData.deliveries || [];
            const totalEarnings = deliveries.reduce((sum, d) => sum + d.amount, 0);
            const totalDeliveries = deliveries.length;
            const avgPerDelivery = totalDeliveries > 0 ? totalEarnings / totalDeliveries : 0;

            // Update display
            document.getElementById('total-earnings').textContent = `$${totalEarnings.toFixed(2)}`;
            document.getElementById('total-deliveries').textContent = totalDeliveries;
            document.getElementById('avg-delivery').textContent = `$${avgPerDelivery.toFixed(2)}`;

            // Update app data for analysis
            appData.analysis.totalEarnings = totalEarnings;
            appData.analysis.totalDeliveries = totalDeliveries;
            appData.analysis.averagePerDelivery = avgPerDelivery;
        }

        function openTabSelector() {
            tabSelector.classList.remove('hidden');
        }

        // Right-click handler
        contentArea.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            openTabSelector();
        });

        // Button click handler
        menuButton.addEventListener('click', () => {
            openTabSelector();
        });

        // Single-click on tab selector to close
        tabSelector.addEventListener('click', (e) => {
            if (e.target === tabSelector) {
                tabSelector.classList.add('hidden');
            }
        });

        // Close tab selector on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                tabSelector.classList.add('hidden');
            }
        });

        function switchTab(tab) {
            debug('UI', 'Switching to tab', { tab, currentTab: appData.ui.currentTab });

            // Hide all sections
            document.querySelectorAll('[id$="-section"]').forEach(section => {
                section.classList.add('hidden');
            });

            // Hide welcome screen
            welcomeScreen.classList.add('hidden');

            // Show selected section
            document.getElementById(`${tab}-section`).classList.remove('hidden');

            // Close tab selector
            tabSelector.classList.add('hidden');

            // Load settings if switching to settings tab
            if (tab === 'settings') {
                loadSettings();
            }

            debug('UI', 'Tab switch complete', { newTab: tab });
        }

        // Load settings on page load
        loadSettings();

        // Add scroll event listeners to save positions
        const sections = ['deliveries-section', 'analysis-section', 'settings-section'];
        sections.forEach(sectionId => {
            const section = document.getElementById(sectionId);
            if (section) {
                section.addEventListener('scroll', debounce(() => {
                    localStorage.setItem(`scroll_${sectionId}`, section.scrollTop);
                }, 200));
            }
        });

        // Auto-save on input changes
        document.getElementById('monthly-goal')?.addEventListener('change', saveAllData);
        document.getElementById('monthly-goal')?.addEventListener('input', debounce(() => saveAllData(), 500));
        document.getElementById('avg-per-order')?.addEventListener('change', saveAllData);
        document.getElementById('avg-per-order')?.addEventListener('input', debounce(() => saveAllData(), 500));

        // Auto-save when switching tabs
        const originalSwitchTab = switchTab;
        switchTab = function(tab) {
            // Save scroll position before switching (skip during initial load)
            if (!isInitialLoad) {
                saveScrollPositions();
                saveAllData();
            }
            appData.ui.currentTab = tab;
            originalSwitchTab(tab);

            // Restore scroll position after switching
            setTimeout(() => {
                restoreScrollPosition(`${tab}-section`);
            }, 150);

            // Update analysis when switching to analysis tab
            if (tab === 'analysis') {
                updateAnalysis();
            }

            // Clear initial load flag after first switch
            setTimeout(() => {
                isInitialLoad = false;
            }, 200);
        };

        // Save before page unload
        window.addEventListener('beforeunload', saveAllData);

        // Enter key handler for settings page to return to analysis
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                const settingsSection = document.getElementById('settings-section');
                // Check if we're on the settings page
                if (!settingsSection.classList.contains('hidden')) {
                    switchTab('analysis');
                }
            }
        });
    </script>
</body>
</html>
